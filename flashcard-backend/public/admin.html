<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    .row { display: flex; gap: 8px; align-items: center; margin-bottom: 16px; }
    input[type="text"] { padding: 8px; min-width: 280px; }
    button { padding: 8px 12px; cursor: pointer; }
    .section { margin-top: 24px; }
    .item { border: 1px solid #ddd; padding: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .muted { color: #666; font-size: 0.9em; }
    .counts { margin-top: 8px; }
  </style>
</head>
<body>
  <h2>Admin: View & Manage User Data</h2>

  <div class="row">
    <label for="username">Username:</label>
    <input id="username" type="text" placeholder="Enter username‚Ä¶" />
    <button id="searchBtn">Search</button>
  </div>

  <div id="status" class="muted"></div>
  <div class="counts" id="counts"></div>

  <div class="section">
    <h3>Sets</h3>
    <div id="sets"></div>
  </div>

  <div class="section">
    <h3>Cards</h3>
    <div id="cards"></div>
  </div>

  <div class="section">
    <h3>Quizzes</h3>
    <div id="quizzes"></div>
  </div>

  <!-- ‚úÖ Load socket.io AFTER DOM is ready -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const BASE_URL = '';

    const els = {
      username: document.getElementById('username'),
      searchBtn: document.getElementById('searchBtn'),
      status: document.getElementById('status'),
      counts: document.getElementById('counts'),
      sets: document.getElementById('sets'),
      cards: document.getElementById('cards'),
      quizzes: document.getElementById('quizzes'),
    };

    function authHeaders() {
      return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${sessionStorage.getItem('token') || ''}`
      };
    }

    (function guard() {
      const role = sessionStorage.getItem('role');
      const token = sessionStorage.getItem('token');
      if (!token) {
        alert('Please log in.');
        window.location.href = '/login.html';
        return;
      }
      if (role !== 'admin') {
        alert('Admins only.');
        window.location.href = '/user.html';
      }
    })();

function itemRow(label, onDelete, onEdit) {
  const row = document.createElement('div');
  row.className = 'item';

  const left = document.createElement('div');
  left.innerHTML = label;

  const buttonContainer = document.createElement('div');

  const delBtn = document.createElement('button');
  delBtn.textContent = 'Delete';
  delBtn.addEventListener('click', onDelete);

  const editBtn = document.createElement('button');
  editBtn.textContent = 'Edit';
  editBtn.style.marginLeft = '6px';
  editBtn.addEventListener('click', onEdit);

  buttonContainer.appendChild(editBtn);
  buttonContainer.appendChild(delBtn);

  row.appendChild(left);
  row.appendChild(buttonContainer);

  return row;
}


    async function deleteItem(username, type, id) {
      if (!confirm(`Delete this ${type}?`)) return;
      els.status.textContent = 'Deleting‚Ä¶';
      try {
        const res = await fetch(`${BASE_URL}/admin/delete/${encodeURIComponent(username)}/${type}/${id}`, {
          method: 'DELETE',
          headers: authHeaders()
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Delete failed');
        els.status.textContent = data.message || 'Deleted';

        // Emit event to clients
        socket.emit('admin-delete', { type, id });

        await search(); // Refresh UI
      } catch (err) {
        els.status.textContent = `Error: ${err.message}`;
      }
    }

    async function editItem(username, type, item) {
  const updated = { ...item };

  if (type === 'set') {
    const newTitle = prompt('Edit Set Title:', item.title);
    if (!newTitle || newTitle === item.title) return;
    updated.title = newTitle;
  }

  if (type === 'card') {
    const newTerm = prompt('Edit Term:', item.term);
    const newDef = prompt('Edit Definition:', item.definition);
    if (!newTerm || !newDef || (newTerm === item.term && newDef === item.definition)) return;
    updated.term = newTerm;
    updated.definition = newDef;
  }

  if (type === 'quiz') {
    const newTitle = prompt('Edit Quiz Title:', item.title);
    const newDesc = prompt('Edit Quiz Description:', item.description);
    if (!newTitle || !newDesc || (newTitle === item.title && newDesc === item.description)) return;
    updated.title = newTitle;
    updated.description = newDesc;
  }

  try {
    const res = await fetch(`/admin/edit/${username}/${type}/${item._id}`, {
      method: 'PUT',
      headers: authHeaders(),
      body: JSON.stringify(updated)
    });
    const result = await res.json();
    if (!res.ok) throw new Error(result.message || 'Edit failed');
    els.status.textContent = '‚úÖ Updated successfully';
    await search();
  } catch (err) {
    els.status.textContent = `‚ùå Edit failed: ${err.message}`;
  }
}


    function renderCounts(counts, user) {
      els.counts.textContent = '';
      if (!counts) return;
      const div = document.createElement('div');
      div.innerHTML = `
        <strong>User:</strong> ${user.username} (${user.role})<br/>
        <strong>Sets:</strong> ${counts.sets} &nbsp; | &nbsp;
        <strong>Cards:</strong> ${counts.cards} &nbsp; | &nbsp;
        <strong>Quizzes:</strong> ${counts.quizzes}
      `;
      els.counts.appendChild(div);
    }

    function renderSets(sets, username) {
      els.sets.textContent = '';
      if (!sets?.length) {
        els.sets.innerHTML = '<div class="muted">No sets.</div>';
        return;
      }
      sets.forEach(s => {
        const html = `
          <div><strong>${s.title || '(untitled set)'}</strong>
          <div class="muted">_id: ${s._id}</div>
          <div class="muted">cards: ${s.cardsCount ?? 0}</div></div>
        `;
        const row = itemRow(
  html,
  () => deleteItem(username, 'set', s._id),
  () => editItem(username, 'set', s)
);

        els.sets.appendChild(row);
      });
    }

    function renderCards(cards, username) {
      els.cards.textContent = '';
      if (!cards?.length) {
        els.cards.innerHTML = '<div class="muted">No cards.</div>';
        return;
      }
      cards.forEach(c => {
        const html = `
          <div><strong>${c.term || '(no term)'}</strong> ‚Äì ${c.definition || '(no definition)'}
          <div class="muted">_id: ${c._id} &nbsp; | &nbsp; setId: ${c.setId}</div></div>
        `;
        const row = itemRow(
  html,
  () => deleteItem(username, 'card', c._id),
  () => editItem(username, 'card', c)
);

        els.cards.appendChild(row);
      });
    }

    function renderQuizzes(quizzes, username) {
      els.quizzes.textContent = '';
      if (!quizzes?.length) {
        els.quizzes.innerHTML = '<div class="muted">No quizzes.</div>';
        return;
      }
      quizzes.forEach(q => {
        const html = `
          <div><strong>${q.title || '(untitled quiz)'}</strong>
          <div class="muted">_id: ${q._id}</div></div>
        `;
        const row = itemRow(
  html,
  () => deleteItem(username, 'quiz', q._id),
  () => editItem(username, 'quiz', q)
);

        els.quizzes.appendChild(row);
      });
    }

    // ‚úÖ Expose globally for debugging
    window.search = async function search() {
      const username = els.username.value.trim();
      if (!username) {
        els.status.textContent = 'Please enter a username.';
        return;
      }

      els.status.textContent = 'Loading‚Ä¶';

      try {
        const res = await fetch(`${BASE_URL}/admin/user-data?username=${encodeURIComponent(username)}`, {
          headers: authHeaders()
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Request failed');

        els.status.textContent = 'Loaded.';
        renderCounts(data.counts, data.user);
        renderSets(data.sets, data.user.username);
        renderCards(data.cards, data.user.username);
        renderQuizzes(data.quizzes, data.user.username);
      } catch (err) {
        els.status.textContent = `Error: ${err.message}`;
        els.counts.textContent = '';
        els.sets.textContent = '';
        els.cards.textContent = '';
        els.quizzes.textContent = '';
      }
    }

    els.searchBtn.addEventListener('click', search);
    els.username.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') search();
    });

    socket.on('item-edited', ({ type, id, updates }) => {
  console.log(`‚úèÔ∏è Realtime edit for ${type} - ${id}`, updates);

  const container = type === 'set' ? els.sets :
                    type === 'card' ? els.cards :
                    type === 'quiz' ? els.quizzes : null;

  if (!container) return;

  const items = container.querySelectorAll('.item');
  items.forEach(row => {
    const idMatch = row.innerHTML.includes(id);
    if (!idMatch) return;

    // Update inner HTML based on type and new values
    if (type === 'set' && updates.title) {
      const titleNode = row.querySelector('strong');
      if (titleNode) titleNode.textContent = updates.title;
    }

    if (type === 'card' && updates.term && updates.definition) {
      const strong = row.querySelector('strong');
      const muted = row.querySelector('.muted');
      if (strong && muted) {
        strong.textContent = updates.term;
        muted.previousSibling.textContent = ` ‚Äì ${updates.definition}`;
      }
    }

    if (type === 'quiz' && updates.title) {
      const titleNode = row.querySelector('strong');
      if (titleNode) titleNode.textContent = updates.title;
    }
  });
});

socket.on('item-deleted', ({ type, id }) => {
  console.log(`üßπ Realtime delete for ${type} - ${id}`);

  const container = type === 'set' ? els.sets :
                    type === 'card' ? els.cards :
                    type === 'quiz' ? els.quizzes : null;

  if (!container) return;

  const items = container.querySelectorAll('.item');
  items.forEach(row => {
    if (row.innerHTML.includes(id)) {
      row.remove();
    }
  });
});


  </script>
</body>
</html>
