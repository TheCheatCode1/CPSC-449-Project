<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="/images/quickflashfav.png" type="image/png">
    <meta charset="UTF-8">
    <title>AI Flashcards</title>
    <style>
body {
  font-family: Arial, sans-serif;
  margin: 0; padding: 0;
  display: flex;
  background-color: #B69DDD;
}

/* Sidebar */
#sidebar-container {
  height: 100vh;
}

#sidebar {
  height: 100%;
  width: 60px;
  background-color: #111;
  color: white;
  overflow-x: hidden;
  transition: width 0.3s;
  display: flex;
  flex-direction: column;
  padding-top: 20px;
  position: relative;
}

#sidebar.expanded {
  width: 200px;
}

.sidebar-item {
  display: flex;
  align-items: center;
  width: 100%;
  padding: 10px;
  cursor: pointer;
  color: #818181;
  transition: background-color 0.3s, color 0.3s;
}

.sidebar-item:hover {
  background-color: #333;
  color: white;
}

.sidebar-icon {
  font-size: 20px;
  width: 30px;
  text-align: center;
}

.label {
  opacity: 0;
  white-space: nowrap;
  overflow: hidden;
  transition: opacity 0.3s ease, margin-left 0.3s ease;
  margin-left: 0;
}

#sidebar.expanded .label {
  opacity: 1;
  margin-left: 10px;
}

#sidebar:not(.expanded) .label {
  display: none;
}

#logoutButton {
  margin-top: auto;
  margin-bottom: 30px;
}

/* Main content */
#main-content {
  flex: 1;
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}

input, select {
  margin: 5px 0;
  width: 750px;
  padding: 5px;
  font-size: 1rem;
}

.flashcard {
  border: 1px solid #ccc;
  padding: 10px;
  margin: 10px 0;
  width: 800px;
  text-align: left;
}

#loading, #message {
  width: 750px;
  margin-top: 1rem;
}



    </style>
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar-container"></div>

  <!-- Content -->
  <div id="main-content">
    <h1>ðŸ¤– AI Flashcard Generator</h1>

    <form id="aiForm">
      <div>
        <label for="topic">Topic/Subject:</label><br>
        <input type="text" id="topic" placeholder="e.g., JavaScript, Node.js, Postgres, etc." required>
      </div>
      <div>
        <label for="count">Number of Flashcards (1-10):</label><br>
        <select id="count">
          <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
          <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
          <option value="9">9</option><option value="10">10</option>
        </select>
      </div>
      <button type="submit" id="generateBtn">Generate Flashcards</button>
    </form>

    <div id="loading" style="display: none;">Generating flashcards... Please wait...</div>
    <div id="message" style="color:red;"></div>
    <div id="flashcardsContainer" style="margin-top:1rem;"></div>
  </div>

  <script>
    // redirect if not a 'user'
    const role = sessionStorage.getItem('role');
    if (role !== 'user') {
      alert('Unauthorized access. Redirecting to login.');
      window.location.href = '/';
    }

    // load sidebar
    const sidebarPath = role === 'admin' ? '/adminSidebar.html' : '/sidebar.html';
    
    fetch(sidebarPath)
      .then(r => r.text())
      .then(html => {
        const sb = document.getElementById('sidebar-container');
        sb.innerHTML = html;
const sidebar = document.getElementById('sidebar');
if (sidebar) {
  sidebar.addEventListener('mouseenter', () => sidebar.classList.add('expanded'));
  sidebar.addEventListener('mouseleave', () => sidebar.classList.remove('expanded'));
}

        document.getElementById('logoutButton')
                .addEventListener('click', ()=> {
          sessionStorage.clear();
          window.location.href = '/';
        });
      });

    // element refs
    const form = document.getElementById('aiForm');
    const topicInput = document.getElementById('topic');
    const countSelect = document.getElementById('count');
    const loading = document.getElementById('loading');
    const messageDiv = document.getElementById('message');
    const container = document.getElementById('flashcardsContainer');
    const genBtn = document.getElementById('generateBtn');

    // handle generate
    form.addEventListener('submit', async e => {
      e.preventDefault();
      container.innerHTML = '';
      messageDiv.textContent = '';
      genBtn.disabled = true;
      loading.style.display = 'block';

      try {
        const token = sessionStorage.getItem('token');
        const res = await fetch('/api/flashcards/ai-generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            topic: topicInput.value.trim(),
            count: countSelect.value
          })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to generate');
        displayFlashcards(data.flashcards, topicInput.value.trim());
      } catch (err) {
        console.error(err);
        messageDiv.textContent = err.message;
      } finally {
        genBtn.disabled = false;
        loading.style.display = 'none';
      }
    });

    // show cards + save btn
    function displayFlashcards(flashcards, topic) {
      const hdr = document.createElement('h2');
      hdr.textContent = `Generated Flashcards for: ${topic}`;
      container.append(hdr);

      flashcards.forEach(f => {
        const d = document.createElement('div');
        d.className = 'flashcard';
        d.innerHTML = `
          <h3>${f.front}</h3>
          <p><strong>Definition:</strong> ${f.back}</p>
          <p><strong>Example:</strong> ${f.example}</p>`;
        container.append(d);
      });

      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'Save to My Flashcards';
      saveBtn.onclick = e => saveFlashcards(flashcards, topic, e.target);
      container.append(saveBtn);
    }

    // persist set + cards
    async function saveFlashcards(flashcards, topic, btn) {
      btn.disabled = true;
      btn.textContent = 'Saving...';
      try {
        const token = sessionStorage.getItem('token');
        const user = sessionStorage.getItem('username');
        let r = await fetch('/api/flashcards/sets', {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            title: `AI Generated - ${topic}`,
            description: `AI-generated flashcards for ${topic}`,
            createdBy: sessionStorage.getItem('userId')
          })
        });
        if (!r.ok) throw new Error('Set creation failed');
        const set = await r.json();
        for (let f of flashcards) {
          await fetch('/api/flashcards/cards', {
            method:'POST',
            headers:{
              'Content-Type':'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              setId: set._id,
              term: f.front,
              definition: f.back,
              example: f.example
            })
          });
        }
        alert('AI Flashcards saved successfully!');
        btn.textContent = 'Saved!';
      } catch (err) {
        console.error(err);
        alert(err.message || 'Failed to save');
        btn.disabled = false;
        btn.textContent = 'Save to My Flashcards';
      }
    }
  </script>
</body>
</html>
