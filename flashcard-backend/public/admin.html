<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    .row { display: flex; gap: 8px; align-items: center; margin-bottom: 16px; }
    input[type="text"] { padding: 8px; min-width: 280px; }
    button { padding: 8px 12px; cursor: pointer; }
    .section { margin-top: 24px; }
    .item { border: 1px solid #ddd; padding: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .muted { color: #666; font-size: 0.9em; }
    .counts { margin-top: 8px; }
  </style>
</head>
<body>
  <h2>Admin: View & Manage User Data</h2>

  <div class="row">
    <label for="username">Username:</label>
    <input id="username" type="text" placeholder="Enter username…" />
    <button id="searchBtn">Search</button>
  </div>

  <div id="status" class="muted"></div>
  <div class="counts" id="counts"></div>

  <div class="section">
    <h3>Sets</h3>
    <div id="sets"></div>
  </div>

  <div class="section">
    <h3>Cards</h3>
    <div id="cards"></div>
  </div>

  <div class="section">
    <h3>Quizzes</h3>
    <div id="quizzes"></div>
  </div>

  <!-- ✅ Load socket.io AFTER DOM is ready -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const BASE_URL = '';

    const els = {
      username: document.getElementById('username'),
      searchBtn: document.getElementById('searchBtn'),
      status: document.getElementById('status'),
      counts: document.getElementById('counts'),
      sets: document.getElementById('sets'),
      cards: document.getElementById('cards'),
      quizzes: document.getElementById('quizzes'),
    };

    function authHeaders() {
      return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${sessionStorage.getItem('token') || ''}`
      };
    }

    (function guard() {
      const role = sessionStorage.getItem('role');
      const token = sessionStorage.getItem('token');
      if (!token) {
        alert('Please log in.');
        window.location.href = '/login.html';
        return;
      }
      if (role !== 'admin') {
        alert('Admins only.');
        window.location.href = '/user.html';
      }
    })();

    function itemRow(label, onDelete) {
      const row = document.createElement('div');
      row.className = 'item';
      const left = document.createElement('div');
      left.innerHTML = label;
      const delBtn = document.createElement('button');
      delBtn.textContent = 'Delete';
      delBtn.addEventListener('click', onDelete);
      row.appendChild(left);
      row.appendChild(delBtn);
      return row;
    }

    async function deleteItem(username, type, id) {
      if (!confirm(`Delete this ${type}?`)) return;
      els.status.textContent = 'Deleting…';
      try {
        const res = await fetch(`${BASE_URL}/admin/delete/${encodeURIComponent(username)}/${type}/${id}`, {
          method: 'DELETE',
          headers: authHeaders()
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Delete failed');
        els.status.textContent = data.message || 'Deleted';

        // Emit event to clients
        socket.emit('admin-delete', { type, id });

        await search(); // Refresh UI
      } catch (err) {
        els.status.textContent = `Error: ${err.message}`;
      }
    }

    function renderCounts(counts, user) {
      els.counts.textContent = '';
      if (!counts) return;
      const div = document.createElement('div');
      div.innerHTML = `
        <strong>User:</strong> ${user.username} (${user.role})<br/>
        <strong>Sets:</strong> ${counts.sets} &nbsp; | &nbsp;
        <strong>Cards:</strong> ${counts.cards} &nbsp; | &nbsp;
        <strong>Quizzes:</strong> ${counts.quizzes}
      `;
      els.counts.appendChild(div);
    }

    function renderSets(sets, username) {
      els.sets.textContent = '';
      if (!sets?.length) {
        els.sets.innerHTML = '<div class="muted">No sets.</div>';
        return;
      }
      sets.forEach(s => {
        const html = `
          <div><strong>${s.title || '(untitled set)'}</strong>
          <div class="muted">_id: ${s._id}</div>
          <div class="muted">cards: ${s.cardsCount ?? 0}</div></div>
        `;
        const row = itemRow(html, () => deleteItem(username, 'set', s._id));
        els.sets.appendChild(row);
      });
    }

    function renderCards(cards, username) {
      els.cards.textContent = '';
      if (!cards?.length) {
        els.cards.innerHTML = '<div class="muted">No cards.</div>';
        return;
      }
      cards.forEach(c => {
        const html = `
          <div><strong>${c.term || '(no term)'}</strong> – ${c.definition || '(no definition)'}
          <div class="muted">_id: ${c._id} &nbsp; | &nbsp; setId: ${c.setId}</div></div>
        `;
        const row = itemRow(html, () => deleteItem(username, 'card', c._id));
        els.cards.appendChild(row);
      });
    }

    function renderQuizzes(quizzes, username) {
      els.quizzes.textContent = '';
      if (!quizzes?.length) {
        els.quizzes.innerHTML = '<div class="muted">No quizzes.</div>';
        return;
      }
      quizzes.forEach(q => {
        const html = `
          <div><strong>${q.title || '(untitled quiz)'}</strong>
          <div class="muted">_id: ${q._id}</div></div>
        `;
        const row = itemRow(html, () => deleteItem(username, 'quiz', q._id));
        els.quizzes.appendChild(row);
      });
    }

    // ✅ Expose globally for debugging
    window.search = async function search() {
      const username = els.username.value.trim();
      if (!username) {
        els.status.textContent = 'Please enter a username.';
        return;
      }

      els.status.textContent = 'Loading…';

      try {
        const res = await fetch(`${BASE_URL}/admin/user-data?username=${encodeURIComponent(username)}`, {
          headers: authHeaders()
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Request failed');

        els.status.textContent = 'Loaded.';
        renderCounts(data.counts, data.user);
        renderSets(data.sets, data.user.username);
        renderCards(data.cards, data.user.username);
        renderQuizzes(data.quizzes, data.user.username);
      } catch (err) {
        els.status.textContent = `Error: ${err.message}`;
        els.counts.textContent = '';
        els.sets.textContent = '';
        els.cards.textContent = '';
        els.quizzes.textContent = '';
      }
    }

    els.searchBtn.addEventListener('click', search);
    els.username.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') search();
    });
  </script>
</body>
</html>
