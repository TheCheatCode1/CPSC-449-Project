<script src="/socket.io/socket.io.js"></script>


<!DOCTYPE html>
<link rel="icon" href="/images/quickflashfav.png" type="image/png">

<html lang="en">
<head>
  <link rel="icon" href="/images/quickflashfav.png" type="image/png">
  <meta charset="UTF-8" />
  <title>Create a Quiz</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      background-color: #B69DDD;
    }

    #sidebar {
      height: 100vh;
      width: 60px;
      background-color: #111;
      overflow-x: hidden;
      transition: width 0.3s;
      color: white;
      display: flex;
      flex-direction: column;
      padding-top: 20px;
      position: relative;
    }

    #sidebar.expanded {
      width: 200px;
    }

    .sidebar-item {
      display: flex;
      align-items: center;
      width: 100%;
      padding: 10px;
      cursor: pointer;
      color: #818181;
      transition: background-color 0.3s, color 0.3s;
    }

    .sidebar-item:hover {
      background-color: #333;
      color: white;
    }

    .sidebar-icon {
      font-size: 20px;
      width: 30px;
      text-align: center;
    }

    .label {
      opacity: 0;
      white-space: nowrap;
      overflow: hidden;
      transition: opacity 0.3s ease, margin-left 0.3s ease;
      margin-left: 0;
    }

    #sidebar.expanded .label {
      opacity: 1;
      margin-left: 10px;
    }

    #sidebar:not(.expanded) .label {
      display: none;
    }

    #logoutButton {
      margin-top: auto;
      margin-bottom: 30px;
    }

    #main-content {
      flex: 1;
      padding: 20px;
    }

    input, textarea, select {
      display: block;
      margin: 10px 0;
      width: 300px;
    }

    .question-block {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 20px;
    }

    .question-block input.option {
      width: 90%;
    }
  </style>
</head>
<body>
<div id="sidebar-container"></div>

<script>
    // Check if user is admin and load appropriate sidebar
    const role = sessionStorage.getItem('role');
    const sidebarPath = role === 'admin' ? '/adminSidebar.html' : '/sidebar.html';
    
    fetch(sidebarPath)
        .then(response => response.text())
        .then(html => {
            document.getElementById('sidebar-container').innerHTML = html;

            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.addEventListener('mouseenter', () => sidebar.classList.add('expanded'));
                sidebar.addEventListener('mouseleave', () => sidebar.classList.remove('expanded'));
            }

            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', () => {
                    sessionStorage.clear();
                    window.location.href = '/';
                });
            }
        });
</script>


  <div id="main-content">
    <h2>Create a New Quiz</h2>
    

    <form id="quizForm">
      <input type="text" id="quizTitle" placeholder="Quiz Title" required />
      <textarea id="quizDesc" placeholder="Quiz Description"></textarea>

      <div id="questionsContainer"></div>

      <button type="button" onclick="addQuestion()">+ Add Question</button>
      <button type="button" onclick="submitQuiz()">Save Quiz</button>

    </form>

    <h3>Take a Quiz via QuizAPI</h3>
<select id="quizTopic">
  <option value="">Select a topic</option>
  <option value="javascript">JavaScript</option>
  <option value="html">HTML</option>
  <option value="css">CSS</option>
  <option value="linux">Linux</option>
  <option value="bash">Bash</option>
  <option value="code">Code</option>
</select>

<button onclick="fetchFromQuizAPI()">Load Quiz</button>
<div id="quizApiResult"></div>


    <h3>Saved Quizzes</h3>
<div id="savedQuizzes"></div>

  </div>

  <script>
    const questionsContainer = document.getElementById('questionsContainer');

    function addQuestion() {
      const index = questionsContainer.children.length;
      const div = document.createElement('div');
      div.className = 'question-block';
      div.innerHTML = `
        <input type="text" class="question" placeholder="Question text" required />
        <input type="text" class="option" placeholder="Option A" required />
        <input type="text" class="option" placeholder="Option B" required />
        <input type="text" class="option" placeholder="Option C" />
        <input type="text" class="option" placeholder="Option D" />
        <select class="correct" required>
          <option value="">Select correct answer</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D">D</option>
        </select>
      `;
      questionsContainer.appendChild(div);
    }

async function submitQuiz() {
  const title = document.getElementById('quizTitle').value;
  const description = document.getElementById('quizDesc').value;
  const blocks = document.querySelectorAll('.question-block');

  const questions = [];

  blocks.forEach(block => {
    const questionText = block.querySelector('.question').value;
    const options = Array.from(block.querySelectorAll('.option')).map(opt => opt.value).filter(Boolean);
    const correct = block.querySelector('.correct').value;
    const correctAnswer = options[['A', 'B', 'C', 'D'].indexOf(correct)];

    questions.push({
      question: questionText,
      options,
      correctAnswer
    });
  });

  const token = sessionStorage.getItem('token');
  const response = await fetch('/api/quizzes', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({ title, description, questions })
  });

  const result = await response.json();

  if (response.ok && result._id) {
    alert('‚úÖ Quiz saved successfully!');
    loadSavedQuizzes(); // Refresh the Saved Quizzes section
    document.getElementById('quizForm').reset(); // Clear the form
    document.getElementById('questionsContainer').innerHTML = '';
    addQuestion(); // Start fresh
  } else {
    console.error('Quiz creation failed:', result);
    alert('‚ùå Quiz creation failed. Check console.');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  addQuestion(); // Start with one question once DOM is ready
});

document.addEventListener('DOMContentLoaded', () => {
  loadSavedQuizzes(); // or whatever functions you're running
});


  </script>

  <script>
  async function loadSavedQuizzes() {
    const token = sessionStorage.getItem('token');
    try {
      const res = await fetch('/api/quizzes', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      const quizzes = await res.json();
      const container = document.getElementById('savedQuizzes');
      container.innerHTML = '';

      if (!quizzes.length) {
        container.textContent = 'No saved quizzes yet.';
        return;
      }

     quizzes.forEach(quiz => {
const box = document.createElement('div');
box.setAttribute('data-id', quiz._id); // üîë Add this

  box.style.border = '1px solid #000';
  box.style.padding = '10px';
  box.style.marginBottom = '10px';
  box.style.backgroundColor = '#eee';
  box.style.position = 'relative';

  // Trash can delete button
  const deleteBtn = document.createElement('button');
  deleteBtn.textContent = 'üóëÔ∏è';
  deleteBtn.style.position = 'absolute';
  deleteBtn.style.top = '5px';
  deleteBtn.style.right = '5px';
  deleteBtn.style.border = 'none';
  deleteBtn.style.background = 'transparent';
  deleteBtn.style.cursor = 'pointer';
  deleteBtn.title = 'Delete Quiz';
deleteBtn.onclick = async () => {
  const confirmed = confirm('Are you sure you want to delete this quiz?');
  if (!confirmed) return;

  try {
    const res = await fetch(`/api/quizzes/${quiz._id}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    const result = await res.json();
    if (res.ok) {
      alert('‚úÖ Quiz deleted');
      loadSavedQuizzes();
    } else {
      console.error(result);
      alert('‚ùå Failed to delete quiz');
    }
  } catch (err) {
    console.error(err);
    alert('‚ùå Failed to delete quiz');
  }
};


  const title = document.createElement('strong');
  title.textContent = quiz.title;

  const desc = document.createElement('p');
  desc.textContent = quiz.description;

  const viewBtn = document.createElement('button');
  viewBtn.textContent = 'View Quiz';
  viewBtn.onclick = () => {
    window.location.href = `/takeQuiz.html?id=${quiz._id}`;
  };

  box.appendChild(deleteBtn);
  box.appendChild(title);
  box.appendChild(desc);
  box.appendChild(viewBtn);
  container.appendChild(box);
});

    } catch (err) {
      console.error('Failed to load saved quizzes:', err);
      document.getElementById('savedQuizzes').textContent = 'Error loading quizzes.';
    }
  }

  // Load on page start
  loadSavedQuizzes();
</script>


    <script>
    const sidebar = document.getElementById('sidebar');
    sidebar.addEventListener('mouseenter', () => {
        sidebar.classList.add('expanded');
    });
    sidebar.addEventListener('mouseleave', () => {
        sidebar.classList.remove('expanded');
    });
  </script>
<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  socket.on('connect', () => {
    console.log('‚úÖ WebSocket connected');
  });

  // üóëÔ∏è Handle deletions
  socket.on('item-deleted', ({ type, id }) => {
    console.log(`üßπ Delete broadcast: ${type} - ${id}`);
    try {
      if (type === 'quiz') {
        document.querySelectorAll('#savedQuizzes > div').forEach(div => {
          if (div.getAttribute('data-id') === id) {
            div.remove();
          }
        });
      }
    } catch (err) {
      console.warn('Non-fatal error during delete:', err);
    }
  });

  // ‚úèÔ∏è Handle edits
  socket.on('item-edited', ({ type, id, updates }) => {
    console.log(`‚úèÔ∏è Edit broadcast: ${type} - ${id}`, updates);
    try {
      if (type === 'quiz' && updates.title) {
        document.querySelectorAll('#savedQuizzes > div').forEach(div => {
          if (div.getAttribute('data-id') === id) {
            // üëá Either replace content or just update title if DOM structure allows
            const strongTitle = div.querySelector('strong');
            if (strongTitle) strongTitle.textContent = updates.title;

            const desc = div.querySelector('p');
            if (desc && updates.description) desc.textContent = updates.description;
          }
        });
      }
    } catch (err) {
      console.warn('Non-fatal error during edit:', err);
    }
  });
</script>

<script>
  async function fetchFromQuizAPI() {
    const topic = document.getElementById('quizTopic').value.trim();
    const resultDiv = document.getElementById('quizApiResult');
    if (!topic) return alert('Enter a quiz topic');

    resultDiv.innerHTML = '‚è≥ Loading...';

    try {
const res = await fetch(`https://quizapi.io/api/v1/questions?limit=5&tags=${encodeURIComponent(topic)}`, {
  headers: {
    'X-Api-Key': 'hq77KpOf32Y2h8unkR3dKuMATMb6MDhy555AgOoV'
  }
});


      const questions = await res.json();

      if (!questions.length) {
        resultDiv.innerHTML = '‚ùå No questions found.';
        return;
      }

      resultDiv.innerHTML = '';
      questions.forEach((q, i) => {
        const container = document.createElement('div');
        container.className = 'question-block';
        container.innerHTML = `
          <strong>${i + 1}. ${q.question}</strong><br/>
          ${Object.entries(q.answers)
            .filter(([key, val]) => val !== null)
            .map(([key, val]) => `<label><input type="radio" name="q${i}" value="${key}"> ${val}</label><br/>`)
            .join('')}
        `;
        resultDiv.appendChild(container);
      });

      // Add save button
      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'Save This Quiz';
      saveBtn.onclick = () => saveQuizApiResults(questions, topic);
      resultDiv.appendChild(saveBtn);

    } catch (err) {
      console.error(err);
      resultDiv.innerHTML = '‚ùå Error fetching quiz.';
    }
  }

  async function saveQuizApiResults(questions, topic) {
    const token = sessionStorage.getItem('token');

    const formatted = questions.map(q => {
      const options = Object.values(q.answers).filter(v => v);
      const correctLetter = Object.entries(q.correct_answers).find(([key, val]) => val === 'true')?.[0]?.slice(-1);
      const correctIndex = ['A', 'B', 'C', 'D', 'E', 'F'].indexOf(correctLetter?.toUpperCase());
      const correctAnswer = options[correctIndex];

      return {
        question: q.question,
        options,
        correctAnswer
      };
    });

    const body = {
      title: `QuizAPI - ${topic}`,
      description: `Imported quiz on ${topic} from QuizAPI`,
      questions: formatted
    };

    try {
      const res = await fetch('/api/quizzes', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(body)
      });

      const result = await res.json();
      if (res.ok) {
        alert('‚úÖ Quiz saved successfully!');
        loadSavedQuizzes();
      } else {
        console.error(result);
        alert('‚ùå Save failed');
      }
    } catch (err) {
      console.error(err);
      alert('‚ùå Error saving quiz');
    }
  }
</script>


  </body>
  </html>
